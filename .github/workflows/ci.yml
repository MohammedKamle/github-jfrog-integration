name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  JF_NPM_VIRTUAL: ${{ vars.JF_NPM_VIRTUAL || 'npm-virtual' }}
  JF_NPM_LOCAL: ${{ vars.JF_NPM_LOCAL || 'npm-local' }}
  NODE_VERSION: '20'

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: 2.91.0

      - name: Configure JFrog
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
          JF_USER: ${{ secrets.JF_USER }}
          JF_API_KEY: ${{ secrets.JF_API_KEY }}
        run: |
          if [ -n "$JF_ACCESS_TOKEN" ]; then
            jf c add gh-ci --url "$JF_URL" --access-token "$JF_ACCESS_TOKEN" --interactive=false
          else
            jf c add gh-ci --url "$JF_URL" --user "$JF_USER" --password "$JF_API_KEY" --interactive=false
          fi
          jf c use gh-ci

      - name: Configure npm for JFrog
        run: |
          mkdir -p .jfrog/projects
          cat > .jfrog/projects/npm.yaml << EOF
          version: 1
          type: npm
          resolver:
              repo: ${JF_NPM_VIRTUAL}
              serverId: gh-ci
          deployer:
              repo: ${JF_NPM_LOCAL}
              serverId: gh-ci
          EOF

      - name: Install dependencies
        run: jf npm install --build-name "${{ github.event.repository.name }}" --build-number "${{ github.run_number }}"

      - name: Run tests
        run: npm test
        env:
          BUILD_NAME: ${{ github.event.repository.name }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: Add VCS info to build-info
        run: |
          jf rt build-add-git "${{ github.event.repository.name }}" "${{ github.run_number }}" .

      - name: Publish package to Artifactory
        run: jf npm publish --build-name "${{ github.event.repository.name }}" --build-number "${{ github.run_number }}"

      - name: Publish build-info
        run: |
          jf rt build-publish "${{ github.event.repository.name }}" "${{ github.run_number }}"

      - name: Xray scan (optional)
        if: ${{ vars.JF_XRAY_SCAN_ENABLED == 'true' }}
        run: |
          jf build-scan "${{ github.event.repository.name }}" "${{ github.run_number }}"
